<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>PlacePrep Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<style>
:root{--bg:#060612;--bg2:#0c0c1d;--bg3:#14142b;--brd:rgba(99,102,241,0.12);--t1:#E6EAF0;--t2:#7C8497;--t3:#4A5168;--acc:#5227FF;--accL:#7B5CFF;--accG:rgba(99,102,241,0.15);--grn:#00D68F;--grnG:rgba(16,185,129,0.12);--red:#FF4C6A;--redG:rgba(239,68,68,0.12);--yel:#FFB020;--yelG:rgba(245,158,11,0.12);--pnk:#E040FB;--f:'Outfit',system-ui,sans-serif;--fm:'Fira Code',monospace}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--f);background:var(--bg);color:var(--t1);line-height:1.7;min-height:100vh;letter-spacing:.2px;-webkit-font-smoothing:antialiased;display:flex}
button{font-family:var(--f);cursor:pointer;border:none}input,select,textarea{font-family:var(--f)}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.sb{width:260px;min-height:100vh;background:rgba(12,12,29,0.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-right:1px solid var(--brd);padding:0;display:flex;flex-direction:column;position:fixed;left:0;top:0;bottom:0;z-index:10}
.mc{margin-left:260px;flex:1;padding:28px;min-height:100vh;overflow-y:auto;position:relative;z-index:1}
.card{background:rgba(12,12,29,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--brd);border-radius:16px;padding:24px;transition:all .3s;animation:slideUp .4s ease both}
.card:hover{border-color:rgba(99,102,241,.25)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;transition:all .2s}
.btn-p{background:var(--acc);color:#fff}.btn-p:hover{background:#4520DD}
.btn-s{background:var(--accG);color:var(--accL);border:1px solid var(--brd)}.btn-s:hover{background:rgba(99,102,241,.2)}
.btn-g{background:transparent;color:var(--t2);border:1px solid var(--brd)}.btn-g:hover{border-color:var(--acc);color:var(--accL)}
.btn-d{background:var(--redG);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.btn-ok{background:var(--grnG);color:var(--grn);border:1px solid rgba(16,185,129,.2)}
.btn-sm{padding:6px 14px;font-size:12px}
.inp{width:100%;padding:12px 16px;background:var(--bg3);border:1px solid var(--brd);border-radius:8px;color:var(--t1);font-size:14px;transition:all .2s}
.inp:focus{outline:none;border-color:rgba(99,102,241,.5);box-shadow:0 0 0 3px var(--accG)}
textarea.inp{min-height:80px;resize:vertical}
.nav-i{display:flex;align-items:center;gap:12px;padding:11px 16px;border-radius:8px;color:var(--t2);font-size:14px;font-weight:500;transition:all .2s;width:100%;background:transparent;text-align:left}
.nav-i:hover{background:var(--accG);color:var(--t1)}.nav-i.act{background:var(--accG);color:var(--accL);font-weight:600}
.sv{font-family:var(--fm);font-size:28px;font-weight:700}
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th{text-align:left;padding:12px 14px;color:var(--t2);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--brd)}
.tbl td{padding:12px 14px;border-bottom:1px solid rgba(99,102,241,.06)}
.tbl tr:hover td{background:rgba(99,102,241,.03)}
.bdg{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.bdg-e{background:var(--grnG);color:var(--grn)}.bdg-m{background:var(--yelG);color:var(--yel)}.bdg-h{background:var(--redG);color:var(--red)}
.bdg-a{background:var(--accG);color:var(--accL)}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:rgba(12,12,29,0.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--brd);border-radius:14px;padding:20px;text-align:center}
.stat-card .num{font-family:var(--fm);font-size:32px;font-weight:700}
.stat-card .lbl{font-size:12px;color:var(--t2);margin-top:4px}
.tabs{display:flex;gap:4px;background:var(--bg3);border-radius:8px;padding:3px;margin-bottom:20px}
.tab{flex:1;padding:8px;border-radius:6px;font-size:13px;font-weight:600;background:transparent;color:var(--t3);text-align:center;transition:all .2s}
.tab.act{background:var(--acc);color:#fff}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(4px)}
.mod{background:rgba(12,12,29,0.85);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--brd);border-radius:16px;padding:32px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.search-bar{display:flex;gap:10px;margin-bottom:16px}
.pill{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s}
.pill:hover{opacity:.8}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--t3);border-radius:3px}
@media(max-width:768px){.sb{display:none}.mc{margin-left:0}}
</style>
</head>
<body>

<canvas id="prismBg" style="position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none"></canvas>
<script>
(function(){
const canvas=document.getElementById('prismBg');
const gl=canvas.getContext('webgl',{alpha:true,antialias:false,premultipliedAlpha:false});
if(!gl)return;

function resize(){
  const dpr=Math.min(2,window.devicePixelRatio||1);
  canvas.width=window.innerWidth*dpr;
  canvas.height=window.innerHeight*dpr;
  gl.viewport(0,0,canvas.width,canvas.height);
}
resize();
window.addEventListener('resize',resize);

const vs=`attribute vec2 position;void main(){gl_Position=vec4(position,0.0,1.0);}`;

const fs=`precision highp float;
uniform vec2 iResolution;
uniform float iTime;

vec4 tanh4(vec4 x){vec4 e2x=exp(2.0*x);return(e2x-1.0)/(e2x+1.0);}

float sdOctaAnisoInv(vec3 p){
  float invBH=1.0/2.75;float invH=1.0/3.5;
  vec3 q=vec3(abs(p.x)*invBH,abs(p.y)*invH,abs(p.z)*invBH);
  float m=q.x+q.y+q.z-1.0;
  return m*min(2.75,3.5)*0.5773502691896258;
}

float sdPyramidUpInv(vec3 p){
  float oct=sdOctaAnisoInv(p);
  return max(oct,-p.y);
}

void main(){
  float scale=3.6;
  float pxScale=1.0/(iResolution.y*0.1*scale);
  vec2 f=(gl_FragCoord.xy-0.5*iResolution.xy)*pxScale;
  
  float t=iTime*0.5;
  float c0=cos(t);float c1=cos(t+33.0);float c2=cos(t+11.0);
  
  float z=5.0;float d=0.0;
  vec3 p;vec4 o=vec4(0.0);
  float centerShift=3.5*0.25;
  
  for(int i=0;i<100;i++){
    p=vec3(f,z);
    // wobble
    float nx=p.x*c0+p.z*c1;
    float nz=p.x*c2+p.z*c0;
    p.x=nx;p.z=nz;
    // no extra rotation for 'rotate' mode
    vec3 q=p;
    q.y+=centerShift;
    d=0.1+0.2*abs(sdPyramidUpInv(q));
    z-=d;
    o+=(sin((p.y+z)*1.0+vec4(0.0,1.0,2.0,3.0))+1.0)/d;
  }
  
  o=tanh4(o*o*1.0/1e5);
  vec3 col=o.rgb;
  col=clamp(col,0.0,1.0);
  float L=dot(col,vec3(0.2126,0.7152,0.0722));
  col=clamp(mix(vec3(L),col,1.5),0.0,1.0);
  
  // Darken for readability as background
  col*=0.35;
  
  gl_FragColor=vec4(col,1.0);
}`;

function createShader(type,src){
  const s=gl.createShader(type);
  gl.shaderSource(s,src);gl.compileShader(s);
  if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)){console.error(gl.getShaderInfoLog(s));gl.deleteShader(s);return null}
  return s;
}

const vShader=createShader(gl.VERTEX_SHADER,vs);
const fShader=createShader(gl.FRAGMENT_SHADER,fs);
if(!vShader||!fShader)return;

const prog=gl.createProgram();
gl.attachShader(prog,vShader);gl.attachShader(prog,fShader);gl.linkProgram(prog);
if(!gl.getProgramParameter(prog,gl.LINK_STATUS)){console.error(gl.getProgramInfoLog(prog));return}

gl.useProgram(prog);

// Fullscreen triangle
const buf=gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER,buf);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,3,-1,-1,3]),gl.STATIC_DRAW);
const posLoc=gl.getAttribLocation(prog,'position');
gl.enableVertexAttribArray(posLoc);
gl.vertexAttribPointer(posLoc,2,gl.FLOAT,false,0,0);

const uRes=gl.getUniformLocation(prog,'iResolution');
const uTime=gl.getUniformLocation(prog,'iTime');

const t0=performance.now();
function render(){
  const time=(performance.now()-t0)*0.001;
  gl.uniform2f(uRes,canvas.width,canvas.height);
  gl.uniform1f(uTime,time);
  gl.drawArrays(gl.TRIANGLES,0,3);
  requestAnimationFrame(render);
}
render();
})();
</script>

<div id="app" style="position:relative;z-index:1"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG - User must replace with their own
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_CONFIG = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

let db=null,FB_READY=false;
try{
  if(FIREBASE_CONFIG.apiKey!=='YOUR_API_KEY'){
    firebase.initializeApp(FIREBASE_CONFIG);
    db=firebase.firestore();
    FB_READY=true;
  }
}catch(e){console.warn('Firebase not configured:',e)}

const $=s=>document.querySelector(s);
const esc=s=>(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL STORAGE FALLBACK (works without Firebase too)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB={
  g(k){try{return JSON.parse(localStorage.getItem('pp_'+k))}catch{return null}},
  s(k,v){localStorage.setItem('pp_'+k,JSON.stringify(v))},
  gu(){return this.g('users')||{}},
  gd(e){return this.g('d_'+e)||{at:[],bm:[],sk:[],dc:{}}},
  getAll(){
    const users=this.gu();
    const result=[];
    Object.values(users).forEach(u=>{
      const d=this.gd(u.email);
      result.push({...u,data:d});
    });
    return result;
  }
};

// Question bank reference (same structure as main app)
const T={aptitude:{n:"Aptitude",i:"ğŸ§®",c:"#FFB020"},logical:{n:"Logical Reasoning",i:"ğŸ§©",c:"#8B5CF6"},verbal:{n:"Verbal Ability",i:"ğŸ“",c:"#00D68F"},coding:{n:"Coding & Technical",i:"ğŸ’»",c:"#FF4C6A"},data_interp:{n:"Data Interpretation",i:"ğŸ“ˆ",c:"#E040FB"}};

// Custom questions stored separately
const CQ_KEY='pp_custom_questions';
function getCustomQs(){try{return JSON.parse(localStorage.getItem(CQ_KEY))||[]}catch{return[]}}
function saveCustomQs(qs){localStorage.setItem(CQ_KEY,JSON.stringify(qs))}

// State
let PG='overview',ADMIN_AUTH=false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAuth(){
  $('#app').innerHTML=`<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:transparent;padding:20px">
  <div style="width:100%;max-width:400px;background:rgba(12,12,29,0.8);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--brd);border-radius:20px;padding:44px 36px;position:relative;overflow:hidden">
  <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--red),var(--pnk),var(--acc))"></div>
  <div style="text-align:center;margin-bottom:32px"><div style="font-size:48px;margin-bottom:8px">ğŸ›¡ï¸</div>
  <h1 style="font-size:22px;font-weight:700;background:linear-gradient(135deg,var(--red),var(--pnk));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px">PlacePrep Admin</h1>
  <p style="color:var(--t2);font-size:13px">Administrative Control Panel</p></div>
  <div id="aerr" style="display:none;background:var(--redG);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:10px 14px;margin-bottom:16px;color:var(--red);font-size:13px"></div>
  <div style="margin-bottom:14px"><label style="display:block;font-size:12px;color:var(--t2);margin-bottom:6px;font-weight:500">Admin Password</label>
  <input class="inp" id="apw" type="password" placeholder="Enter admin password"></div>
  <button class="btn btn-p" style="width:100%;padding:14px;background:linear-gradient(135deg,var(--red),var(--pnk))" onclick="doAdminLogin()">Access Admin Panel</button>
  <p style="text-align:center;font-size:11px;color:var(--t3);margin-top:16px">Default: admin123</p>
  </div></div>`;
  setTimeout(()=>$('#apw')?.addEventListener('keydown',e=>{if(e.key==='Enter')doAdminLogin()}),50);
}

function doAdminLogin(){
  const pw=$('#apw')?.value;
  const stored=localStorage.getItem('pp_admin_pw')||'admin123';
  if(pw===stored){ADMIN_AUTH=true;render()}
  else{const el=$('#aerr');el.textContent='Invalid password';el.style.display='block'}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  if(!ADMIN_AUTH){renderAuth();return}
  const navItems=[
    {id:'overview',ic:'ğŸ“Š',l:'Overview'},
    {id:'users',ic:'ğŸ‘¥',l:'User Management'},
    {id:'questions',ic:'ğŸ“',l:'Question Management'},
    {id:'tests',ic:'ğŸ¢',l:'Company Tests'},
    {id:'analytics',ic:'ğŸ“ˆ',l:'Analytics'},
    {id:'activity',ic:'ğŸ•',l:'Activity Log'},
    {id:'content',ic:'ğŸ¨',l:'Content Settings'},
    {id:'export',ic:'ğŸ’¾',l:'Export Data'},
    {id:'settings',ic:'âš™ï¸',l:'Admin Settings'},
  ];
  
  $('#app').innerHTML=`<div class="sb" id="sb"><div style="padding:24px 20px 20px;display:flex;align-items:center;gap:10px">
  <span style="font-size:24px">ğŸ›¡ï¸</span><span style="font-family:var(--fm);font-size:15px;font-weight:700;background:linear-gradient(135deg,var(--red),var(--pnk));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Admin Panel</span></div>
  <nav style="flex:1;padding:0 12px;display:flex;flex-direction:column;gap:2px" id="nl"></nav>
  <div style="border-top:1px solid var(--brd);padding:16px"><button class="btn btn-d" style="width:100%;font-size:12px" onclick="ADMIN_AUTH=false;render()">ğŸ”’ Lock Panel</button>
  <a href="placeprep.html" style="display:block;text-align:center;font-size:11px;color:var(--t2);margin-top:10px;text-decoration:none">â† Back to PlacePrep</a></div></div>
  <div class="mc" id="mc"></div>`;
  
  const nl=$('#nl');
  navItems.forEach(x=>{const b=document.createElement('button');b.className='nav-i '+(PG===x.id?'act':'');
  b.innerHTML=`<span style="font-size:18px;width:24px;text-align:center">${x.ic}</span>${x.l}`;
  b.onclick=()=>{PG=x.id;render()};nl.append(b)});
  
  const mc=$('#mc');
  if(PG==='overview')renderOverview(mc);
  else if(PG==='users')renderUsers(mc);
  else if(PG==='questions')renderQuestions(mc);
  else if(PG==='tests')renderTests(mc);
  else if(PG==='analytics')renderAnalytics(mc);
  else if(PG==='activity')renderActivity(mc);
  else if(PG==='content')renderContent(mc);
  else if(PG==='export')renderExport(mc);
  else if(PG==='settings')renderSettings(mc);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOverview(c){
  const users=DB.getAll();
  const totalTests=users.reduce((s,u)=>s+(u.data.at?.length||0),0);
  const totalQs=users.reduce((s,u)=>s+u.data.at.reduce((ss,a)=>ss+(a.totalQuestions||0),0),0);
  const avgAcc=totalTests?Math.round(users.reduce((s,u)=>s+u.data.at.reduce((ss,a)=>ss+(a.accuracy||0),0),0)/totalTests):0;
  const today=new Date().toDateString();
  const activeToday=users.filter(u=>u.data.sk?.includes(today)).length;
  const customQs=getCustomQs();
  
  c.innerHTML=`<div style="animation:fadeIn .4s"><h2 style="font-size:22px;font-weight:700;margin-bottom:4px">ğŸ“Š Dashboard Overview</h2>
  <p style="color:var(--t2);font-size:14px;margin-bottom:24px">${FB_READY?'ğŸŸ¢ Firebase Connected':'ğŸŸ¡ Local Mode (Firebase not configured)'}</p>
  
  <div class="stat-grid">
  <div class="stat-card"><div class="num" style="color:var(--accL)">${users.length}</div><div class="lbl">Total Users</div></div>
  <div class="stat-card"><div class="num" style="color:var(--grn)">${totalTests}</div><div class="lbl">Tests Taken</div></div>
  <div class="stat-card"><div class="num" style="color:var(--yel)">${totalQs}</div><div class="lbl">Questions Answered</div></div>
  <div class="stat-card"><div class="num" style="color:var(--pnk)">${avgAcc}%</div><div class="lbl">Avg Accuracy</div></div>
  <div class="stat-card"><div class="num" style="color:var(--red)">${activeToday}</div><div class="lbl">Active Today</div></div>
  <div class="stat-card"><div class="num" style="color:var(--accL)">${571+customQs.length}</div><div class="lbl">Total Questions</div></div>
  </div>
  
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px">
  <div class="card"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">ğŸ‘¥ Recent Signups</h3><div id="rsignups"></div></div>
  <div class="card"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">ğŸ† Top Performers</h3><div id="rtop"></div></div>
  </div>
  
  <div class="card"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">ğŸ“Š Question Distribution</h3>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px">${Object.entries(T).map(([k,t])=>{
    return`<div style="padding:14px;border-radius:10px;background:${t.c}0A;border:1px solid ${t.c}22">
    <div style="display:flex;justify-content:space-between"><span style="font-weight:600">${t.i} ${t.n}</span></div></div>`}).join('')}</div></div></div>`;
  
  // Recent signups
  const rs=$('#rsignups');
  if(users.length===0)rs.innerHTML='<p style="color:var(--t3);font-size:13px">No users yet.</p>';
  else users.slice(-5).reverse().forEach(u=>{rs.innerHTML+=`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(99,102,241,.06)">
  <div><span style="font-weight:600;font-size:13px">${esc(u.name)}</span><span style="font-size:11px;color:var(--t3);margin-left:8px">${esc(u.email)}</span></div>
  <span style="font-size:11px;color:var(--t2)">${u.data.at.length} tests</span></div>`});
  
  // Top performers
  const rt=$('#rtop');
  const ranked=users.filter(u=>u.data.at.length>0).map(u=>({...u,avg:Math.round(u.data.at.reduce((s,a)=>s+a.accuracy,0)/u.data.at.length)})).sort((a,b)=>b.avg-a.avg);
  if(ranked.length===0)rt.innerHTML='<p style="color:var(--t3);font-size:13px">No test data yet.</p>';
  else ranked.slice(0,5).forEach((u,i)=>{rt.innerHTML+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(99,102,241,.06)">
  <div style="display:flex;align-items:center;gap:10px"><span style="font-size:16px">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'  '}</span>
  <span style="font-weight:600;font-size:13px">${esc(u.name)}</span></div>
  <span class="bdg ${u.avg>=70?'bdg-e':u.avg>=40?'bdg-m':'bdg-h'}">${u.avg}%</span></div>`});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USER MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUsers(c){
  const users=DB.getAll();
  c.innerHTML=`<div style="animation:fadeIn .4s"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
  <div><h2 style="font-size:22px;font-weight:700;margin-bottom:4px">ğŸ‘¥ User Management</h2>
  <p style="color:var(--t2);font-size:14px">${users.length} registered users</p></div></div>
  <div class="card" style="overflow-x:auto"><table class="tbl"><thead><tr><th>Name</th><th>Email</th><th>Tests</th><th>Avg Accuracy</th><th>Streak</th><th>Role</th><th>Actions</th></tr></thead>
  <tbody id="utbl"></tbody></table></div></div>`;
  
  const tbody=$('#utbl');
  if(users.length===0){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--t3);padding:32px">No users registered yet.</td></tr>';return}
  
  users.forEach(u=>{
    const tt=u.data.at?.length||0;
    const avg=tt?Math.round(u.data.at.reduce((s,a)=>s+(a.accuracy||0),0)/tt):0;
    const streak=calcStreak(u.data.sk||[]);
    tbody.innerHTML+=`<tr>
    <td style="font-weight:600">${esc(u.name)}</td>
    <td style="color:var(--t2);font-size:12px">${esc(u.email)}</td>
    <td>${tt}</td>
    <td><span class="bdg ${avg>=70?'bdg-e':avg>=40?'bdg-m':'bdg-h'}">${avg}%</span></td>
    <td>ğŸ”¥ ${streak}</td>
    <td>${u.adm?'<span class="bdg" style="background:rgba(236,72,153,.12);color:var(--pnk)">Admin</span>':'<span class="bdg bdg-a">Student</span>'}</td>
    <td><button class="btn btn-g btn-sm" onclick="viewUser('${esc(u.email)}')">View</button>
    <button class="btn btn-d btn-sm" onclick="deleteUser('${esc(u.email)}')">Delete</button></td></tr>`;
  });
}

function calcStreak(days){if(!days||!days.length)return 0;const s=[...new Set(days)].sort((a,b)=>new Date(b)-new Date(a));let c=0;const now=new Date;now.setHours(0,0,0,0);for(let i=0;i<s.length;i++){const d=new Date(s[i]);d.setHours(0,0,0,0);if(Math.round((now-d)/864e5)===i)c++;else break}return c}

function viewUser(email){
  const users=DB.gu();const u=users[email];if(!u)return;
  const d=DB.gd(email);
  const tt=d.at?.length||0;const avg=tt?Math.round(d.at.reduce((s,a)=>s+(a.accuracy||0),0)/tt):0;
  const tq=d.at.reduce((s,a)=>s+(a.totalQuestions||0),0);
  
  document.body.insertAdjacentHTML('beforeend',`<div class="mo" id="umod" onclick="if(event.target===this)this.remove()">
  <div class="mod" style="max-width:700px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
  <h3 style="font-size:18px;font-weight:700">${esc(u.name)}'s Profile</h3>
  <button class="btn btn-g btn-sm" onclick="$('#umod').remove()">âœ• Close</button></div>
  
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
  <div class="stat-card" style="padding:14px"><div class="num" style="font-size:22px;color:var(--accL)">${tt}</div><div class="lbl">Tests</div></div>
  <div class="stat-card" style="padding:14px"><div class="num" style="font-size:22px;color:var(--grn)">${avg}%</div><div class="lbl">Avg Acc</div></div>
  <div class="stat-card" style="padding:14px"><div class="num" style="font-size:22px;color:var(--yel)">${tq}</div><div class="lbl">Qs Done</div></div>
  <div class="stat-card" style="padding:14px"><div class="num" style="font-size:22px;color:var(--red)">ğŸ”¥${calcStreak(d.sk)}</div><div class="lbl">Streak</div></div></div>
  
  <h4 style="font-size:14px;font-weight:600;margin-bottom:10px">Recent Tests</h4>
  <div style="max-height:300px;overflow-y:auto">${d.at.length===0?'<p style="color:var(--t3)">No tests taken yet.</p>':
  d.at.slice(-10).reverse().map(a=>`<div style="display:flex;justify-content:space-between;padding:8px 12px;border-radius:8px;background:var(--bg3);margin-bottom:6px;font-size:13px">
  <span>${esc(a.testName||'Practice')}</span>
  <div><span class="bdg ${(a.accuracy||0)>=70?'bdg-e':(a.accuracy||0)>=40?'bdg-m':'bdg-h'}" style="margin-right:8px">${a.accuracy||0}%</span>
  <span style="color:var(--t3)">${a.totalQuestions||'?'} Qs</span></div></div>`).join('')}
  </div></div></div>`);
}

function deleteUser(email){
  if(!confirm('Delete user '+email+'? This cannot be undone.'))return;
  const users=DB.gu();delete users[email];DB.s('users',users);
  localStorage.removeItem('pp_d_'+email);
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUESTION MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let qFilter={topic:'all',diff:'all',search:''};
function renderQuestions(c){
  const custom=getCustomQs();
  c.innerHTML=`<div style="animation:fadeIn .4s"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
  <div><h2 style="font-size:22px;font-weight:700;margin-bottom:4px">ğŸ“ Question Management</h2>
  <p style="color:var(--t2);font-size:14px">571 built-in + ${custom.length} custom questions</p></div>
  <button class="btn btn-p" onclick="showAddQuestion()">+ Add Question</button></div>
  
  <div class="search-bar"><input class="inp" id="qsearch" placeholder="Search questions..." style="flex:1" value="${esc(qFilter.search)}" oninput="qFilter.search=this.value;renderQList()">
  <select class="inp" style="width:160px" id="qtopic" onchange="qFilter.topic=this.value;renderQList()">
  <option value="all">All Topics</option>${Object.entries(T).map(([k,t])=>`<option value="${k}" ${qFilter.topic===k?'selected':''}>${t.i} ${t.n}</option>`).join('')}</select>
  <select class="inp" style="width:120px" id="qdiff" onchange="qFilter.diff=this.value;renderQList()">
  <option value="all">All Levels</option><option value="Easy" ${qFilter.diff==='Easy'?'selected':''}>Easy</option><option value="Medium" ${qFilter.diff==='Medium'?'selected':''}>Medium</option><option value="Hard" ${qFilter.diff==='Hard'?'selected':''}>Hard</option></select></div>
  
  <div class="card" style="max-height:600px;overflow-y:auto"><table class="tbl"><thead><tr><th style="width:40px">#</th><th>Question</th><th>Topic</th><th>Subtopic</th><th>Diff</th><th>Answer</th><th style="width:100px">Actions</th></tr></thead>
  <tbody id="qtbl"></tbody></table></div></div>`;
  renderQList();
}

function renderQList(){
  const custom=getCustomQs();
  let filtered=custom.filter(q=>{
    if(qFilter.topic!=='all'&&q.topic!==qFilter.topic)return false;
    if(qFilter.diff!=='all'&&q.difficulty!==qFilter.diff)return false;
    if(qFilter.search&&!q.question.toLowerCase().includes(qFilter.search.toLowerCase()))return false;
    return true;
  });
  
  const tbody=$('#qtbl');
  if(!tbody)return;
  if(filtered.length===0&&custom.length===0){
    tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;color:var(--t3);padding:32px">No custom questions yet. Click "+ Add Question" to create one.<br><span style="font-size:11px">571 built-in questions are loaded automatically.</span></td></tr>`;return;
  }
  if(filtered.length===0){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--t3);padding:20px">No questions match filter.</td></tr>';return;
  }
  
  tbody.innerHTML=filtered.slice(0,50).map((q,i)=>{
    const tp=T[q.topic];
    return`<tr><td style="color:var(--t3);font-family:var(--fm);font-size:11px">${i+1}</td>
    <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(q.question)}</td>
    <td><span class="pill" style="background:${tp?.c||'var(--acc)'}14;color:${tp?.c||'var(--acc)'}">${tp?.i||''} ${tp?.n||q.topic}</span></td>
    <td style="font-size:12px;color:var(--t2)">${esc(q.concept)}</td>
    <td><span class="bdg bdg-${q.difficulty[0].toLowerCase()}">${q.difficulty}</span></td>
    <td style="font-family:var(--fm);font-size:12px;color:var(--grn)">${String.fromCharCode(65+q.correctAnswer)}</td>
    <td><button class="btn btn-g btn-sm" onclick="editQuestion(${i})" style="margin-right:4px">âœï¸</button><button class="btn btn-d btn-sm" onclick="deleteQuestion(${i})">ğŸ—‘ï¸</button></td></tr>`}).join('');
}

function showAddQuestion(editIdx){
  const isEdit=editIdx!==undefined;
  const custom=getCustomQs();
  const q=isEdit?custom[editIdx]:{question:'',options:['','','',''],correctAnswer:0,topic:'aptitude',concept:'',difficulty:'Medium',explanation:''};
  
  document.body.insertAdjacentHTML('beforeend',`<div class="mo" id="qmod" onclick="if(event.target===this)this.remove()">
  <div class="mod"><h3 style="font-size:18px;font-weight:700;margin-bottom:20px">${isEdit?'Edit':'Add'} Question</h3>
  <div style="margin-bottom:14px"><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Question</label>
  <textarea class="inp" id="qq">${esc(q.question)}</textarea></div>
  
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Option A</label><input class="inp" id="qo0" value="${esc(q.options[0])}"></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Option B</label><input class="inp" id="qo1" value="${esc(q.options[1])}"></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Option C</label><input class="inp" id="qo2" value="${esc(q.options[2])}"></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Option D</label><input class="inp" id="qo3" value="${esc(q.options[3])}"></div></div>
  
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:14px">
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Correct</label>
  <select class="inp" id="qca"><option value="0" ${q.correctAnswer===0?'selected':''}>A</option><option value="1" ${q.correctAnswer===1?'selected':''}>B</option><option value="2" ${q.correctAnswer===2?'selected':''}>C</option><option value="3" ${q.correctAnswer===3?'selected':''}>D</option></select></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Topic</label>
  <select class="inp" id="qtp">${Object.entries(T).map(([k,t])=>`<option value="${k}" ${q.topic===k?'selected':''}>${t.n}</option>`).join('')}</select></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Subtopic</label><input class="inp" id="qsc" value="${esc(q.concept)}"></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Difficulty</label>
  <select class="inp" id="qdf"><option ${q.difficulty==='Easy'?'selected':''}>Easy</option><option ${q.difficulty==='Medium'?'selected':''}>Medium</option><option ${q.difficulty==='Hard'?'selected':''}>Hard</option></select></div></div>
  
  <div style="margin-bottom:20px"><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Explanation</label>
  <textarea class="inp" id="qex" style="min-height:60px">${esc(q.explanation)}</textarea></div>
  
  <div style="display:flex;gap:10px;justify-content:flex-end">
  <button class="btn btn-g" onclick="$('#qmod').remove()">Cancel</button>
  <button class="btn btn-p" onclick="saveQuestion(${isEdit?editIdx:'undefined'})">${isEdit?'Update':'Add'} Question</button></div></div></div>`);
}

function saveQuestion(editIdx){
  const q={question:$('#qq').value.trim(),options:[$('#qo0').value.trim(),$('#qo1').value.trim(),$('#qo2').value.trim(),$('#qo3').value.trim()],
  correctAnswer:parseInt($('#qca').value),topic:$('#qtp').value,concept:$('#qsc').value.trim(),difficulty:$('#qdf').value,explanation:$('#qex').value.trim()};
  
  if(!q.question||!q.options[0]||!q.options[1]||!q.concept){alert('Fill question, at least 2 options, and subtopic');return}
  
  const custom=getCustomQs();
  if(editIdx!==undefined)custom[editIdx]=q;else custom.push(q);
  saveCustomQs(custom);
  $('#qmod')?.remove();
  renderQuestions($('#mc'));
}

function editQuestion(idx){showAddQuestion(idx)}
function deleteQuestion(idx){
  if(!confirm('Delete this question?'))return;
  const custom=getCustomQs();custom.splice(idx,1);saveCustomQs(custom);
  renderQuestions($('#mc'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPANY TESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTests(c){
  const tests=JSON.parse(localStorage.getItem('pp_custom_tests')||'[]');
  const builtIn=[
    {nm:"TCS NQT Foundation",co:"TCS",qs:65,min:75},
    {nm:"TCS NQT Advanced",co:"TCS",qs:35,min:105},
    {nm:"Infosys InfyTQ",co:"Infosys",qs:45,min:105},
    {nm:"Wipro NLTH",co:"Wipro",qs:42,min:96},
    {nm:"Cognizant GenC",co:"Cognizant",qs:64,min:120},
    {nm:"Cognizant GenC Next",co:"Cognizant",qs:67,min:120},
    {nm:"Accenture Assessment",co:"Accenture",qs:70,min:90},
    {nm:"Capgemini Assessment",co:"Capgemini",qs:64,min:100},
  ];
  
  c.innerHTML=`<div style="animation:fadeIn .4s"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
  <div><h2 style="font-size:22px;font-weight:700;margin-bottom:4px">ğŸ¢ Company Tests</h2>
  <p style="color:var(--t2);font-size:14px">8 built-in patterns</p></div></div>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px">${builtIn.map(t=>`<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
  <h4 style="font-size:15px;font-weight:600">${t.nm}</h4>
  <span class="bdg bdg-a">${t.co}</span></div>
  <div style="display:flex;gap:12px;font-size:12px;color:var(--t2)">
  <span>ğŸ“ ${t.qs} Questions</span><span>â± ${t.min} minutes</span></div></div>`).join('')}</div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAnalytics(c){
  const users=DB.getAll();
  const topicStats={};
  Object.keys(T).forEach(k=>topicStats[k]={attempts:0,correct:0,total:0});
  
  users.forEach(u=>{u.data.at.forEach(a=>{
    if(a.topic&&topicStats[a.topic]){topicStats[a.topic].attempts++;topicStats[a.topic].total+=(a.totalQuestions||0);topicStats[a.topic].correct+=Math.round((a.accuracy||0)*(a.totalQuestions||0)/100)}
    if(a.details)a.details.forEach(d=>{if(d.question?.topic&&topicStats[d.question.topic]){topicStats[d.question.topic].total++;if(d.isCorrect)topicStats[d.question.topic].correct++}})
  })});
  
  c.innerHTML=`<div style="animation:fadeIn .4s"><h2 style="font-size:22px;font-weight:700;margin-bottom:4px">ğŸ“ˆ Analytics</h2>
  <p style="color:var(--t2);font-size:14px;margin-bottom:24px">Platform-wide performance insights</p>
  
  <div class="card" style="margin-bottom:20px"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">Topic Performance</h3>
  <table class="tbl"><thead><tr><th>Topic</th><th>Attempts</th><th>Questions Done</th><th>Accuracy</th></tr></thead>
  <tbody>${Object.entries(topicStats).map(([k,s])=>{const tp=T[k];const acc=s.total?Math.round(s.correct/s.total*100):0;
  return`<tr><td><span style="color:${tp.c};font-weight:600">${tp.i} ${tp.n}</span></td>
  <td>${s.attempts}</td><td>${s.total}</td>
  <td><div style="display:flex;align-items:center;gap:8px"><div style="flex:1;height:6px;background:var(--bg3);border-radius:3px;max-width:100px"><div style="width:${acc}%;height:100%;background:${acc>=70?'var(--grn)':acc>=40?'var(--yel)':'var(--red)'};border-radius:3px"></div></div><span style="font-family:var(--fm);font-size:12px;color:${acc>=70?'var(--grn)':acc>=40?'var(--yel)':'var(--red)'}">${acc}%</span></div></td></tr>`}).join('')}</tbody></table></div>
  
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
  <div class="card"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">ğŸ“Š Usage Summary</h3>
  <div style="display:flex;flex-direction:column;gap:10px">
  <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(99,102,241,.06)"><span style="color:var(--t2)">Total Users</span><span style="font-weight:700">${users.length}</span></div>
  <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(99,102,241,.06)"><span style="color:var(--t2)">Users with Tests</span><span style="font-weight:700">${users.filter(u=>u.data.at.length>0).length}</span></div>
  <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(99,102,241,.06)"><span style="color:var(--t2)">Avg Tests/User</span><span style="font-weight:700">${users.length?Math.round(users.reduce((s,u)=>s+u.data.at.length,0)/users.length*10)/10:0}</span></div>
  <div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:var(--t2)">Users with Streak</span><span style="font-weight:700">${users.filter(u=>calcStreak(u.data.sk)>0).length}</span></div></div></div>
  
  <div class="card"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">ğŸ¯ Difficulty Breakdown</h3>
  <p style="color:var(--t3);font-size:13px">Based on built-in question bank</p>
  <div style="margin-top:12px">${['Easy','Medium','Hard'].map(d=>{const cnt=d==='Easy'?146:d==='Medium'?350:75;const pct=Math.round(cnt/571*100);const col=d==='Easy'?'var(--grn)':d==='Medium'?'var(--yel)':'var(--red)';
  return`<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px"><span>${d}</span><span style="color:${col};font-weight:600">${cnt} (${pct}%)</span></div>
  <div style="height:8px;background:var(--bg3);border-radius:4px"><div style="width:${pct}%;height:100%;background:${col};border-radius:4px"></div></div></div>`}).join('')}</div></div></div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIVITY LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderActivity(c){
  const users=DB.getAll();
  const activities=[];
  users.forEach(u=>{
    u.data.at.forEach(a=>{activities.push({type:'test',user:u.name,email:u.email,test:a.testName||'Practice',accuracy:a.accuracy||0,qs:a.totalQuestions||0,date:a.date||Date.now()})});
  });
  activities.sort((a,b)=>b.date-a.date);
  
  c.innerHTML=`<div style="animation:fadeIn .4s"><h2 style="font-size:22px;font-weight:700;margin-bottom:4px">ğŸ• Activity Log</h2>
  <p style="color:var(--t2);font-size:14px;margin-bottom:24px">${activities.length} total activities</p>
  <div class="card"><div style="max-height:600px;overflow-y:auto">${activities.length===0?'<p style="color:var(--t3);text-align:center;padding:32px">No activity yet.</p>':
  activities.slice(0,50).map(a=>{const d=new Date(a.date);const ago=timeAgo(a.date);
  return`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(99,102,241,.06)">
  <div style="display:flex;align-items:center;gap:12px">
  <div style="width:36px;height:36px;border-radius:50%;background:var(--accG);display:flex;align-items:center;justify-content:center;font-size:14px">ğŸ“</div>
  <div><span style="font-weight:600;font-size:13px">${esc(a.user)}</span><span style="color:var(--t3);font-size:12px;margin-left:8px">completed ${esc(a.test)}</span>
  <div style="font-size:11px;color:var(--t3);margin-top:2px">${a.qs} questions Â· ${ago}</div></div></div>
  <span class="bdg ${a.accuracy>=70?'bdg-e':a.accuracy>=40?'bdg-m':'bdg-h'}">${a.accuracy}%</span></div>`}).join('')}</div></div></div>`;
}

function timeAgo(ts){const s=Math.floor((Date.now()-ts)/1000);if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago'}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENT SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderContent(c){
  const cfg=JSON.parse(localStorage.getItem('pp_content')||'{}');
  c.innerHTML=`<div style="animation:fadeIn .4s"><h2 style="font-size:22px;font-weight:700;margin-bottom:4px">ğŸ¨ Content Settings</h2>
  <p style="color:var(--t2);font-size:14px;margin-bottom:24px">Customize landing page and branding</p>
  
  <div class="card" style="margin-bottom:20px"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">Landing Page</h3>
  <div style="display:grid;gap:14px">
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Tagline Badge</label>
  <input class="inp" id="ctag" value="${esc(cfg.tagline||'#1 Interview Prep Platform')}"></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Hero Description</label>
  <textarea class="inp" id="cdesc">${esc(cfg.description||'Master aptitude, reasoning, verbal & coding with company-pattern mock tests, real-time analytics, and adaptive learning.')}</textarea></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Questions Display Text</label>
  <input class="inp" id="cqnum" value="${esc(cfg.qcount||'500+')}"></div>
  <button class="btn btn-p" onclick="saveContent()">ğŸ’¾ Save Changes</button></div></div>
  
  <div class="card"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">Platform Info</h3>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;color:var(--t2);font-size:13px">
  <div>Built-in Questions: <span style="color:var(--t1);font-weight:600">571</span></div>
  <div>Custom Questions: <span style="color:var(--t1);font-weight:600">${getCustomQs().length}</span></div>
  <div>Company Tests: <span style="color:var(--t1);font-weight:600">8</span></div>
  <div>Topics: <span style="color:var(--t1);font-weight:600">5</span></div>
  <div>Subtopics: <span style="color:var(--t1);font-weight:600">54</span></div></div></div></div>`;
}

function saveContent(){
  const cfg={tagline:$('#ctag').value,description:$('#cdesc').value,qcount:$('#cqnum').value};
  localStorage.setItem('pp_content',JSON.stringify(cfg));
  alert('âœ… Content saved! Changes will reflect on the main site.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderExport(c){
  c.innerHTML=`<div style="animation:fadeIn .4s"><h2 style="font-size:22px;font-weight:700;margin-bottom:4px">ğŸ’¾ Export Data</h2>
  <p style="color:var(--t2);font-size:14px;margin-bottom:24px">Download platform data</p>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px">
  <div class="card" style="cursor:pointer" onclick="exportUsers()"><div style="font-size:32px;margin-bottom:8px">ğŸ‘¥</div>
  <h4 style="font-size:15px;font-weight:600;margin-bottom:4px">User Data (CSV)</h4>
  <p style="font-size:12px;color:var(--t2)">Names, emails, test counts, accuracy</p></div>
  
  <div class="card" style="cursor:pointer" onclick="exportQuestions()"><div style="font-size:32px;margin-bottom:8px">ğŸ“</div>
  <h4 style="font-size:15px;font-weight:600;margin-bottom:4px">Custom Questions (JSON)</h4>
  <p style="font-size:12px;color:var(--t2)">All custom-added questions</p></div>
  
  <div class="card" style="cursor:pointer" onclick="exportActivity()"><div style="font-size:32px;margin-bottom:8px">ğŸ•</div>
  <h4 style="font-size:15px;font-weight:600;margin-bottom:4px">Activity Log (CSV)</h4>
  <p style="font-size:12px;color:var(--t2)">All test completions and scores</p></div>
  
  <div class="card" style="cursor:pointer" onclick="exportAll()"><div style="font-size:32px;margin-bottom:8px">ğŸ“¦</div>
  <h4 style="font-size:15px;font-weight:600;margin-bottom:4px">Full Backup (JSON)</h4>
  <p style="font-size:12px;color:var(--t2)">Complete platform data export</p></div></div></div>`;
}

function downloadFile(name,content,type){
  const blob=new Blob([content],{type});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=name;a.click();URL.revokeObjectURL(url);
}

function exportUsers(){
  const users=DB.getAll();
  let csv='Name,Email,Tests Taken,Avg Accuracy,Total Questions,Streak,Role\n';
  users.forEach(u=>{const tt=u.data.at.length;const avg=tt?Math.round(u.data.at.reduce((s,a)=>s+a.accuracy,0)/tt):0;
  csv+=`"${u.name}","${u.email}",${tt},${avg}%,${u.data.at.reduce((s,a)=>s+(a.totalQuestions||0),0)},${calcStreak(u.data.sk)},${u.adm?'Admin':'Student'}\n`});
  downloadFile('placeprep_users.csv',csv,'text/csv');
}

function exportQuestions(){
  downloadFile('placeprep_questions.json',JSON.stringify(getCustomQs(),null,2),'application/json');
}

function exportActivity(){
  const users=DB.getAll();
  let csv='User,Email,Test,Accuracy,Questions,Date\n';
  users.forEach(u=>{u.data.at.forEach(a=>{csv+=`"${u.name}","${u.email}","${a.testName||'Practice'}",${a.accuracy||0}%,${a.totalQuestions||0},"${new Date(a.date||0).toLocaleString()}"\n`})});
  downloadFile('placeprep_activity.csv',csv,'text/csv');
}

function exportAll(){
  const data={users:DB.getAll(),customQuestions:getCustomQs(),exportDate:new Date().toISOString()};
  downloadFile('placeprep_backup.json',JSON.stringify(data,null,2),'application/json');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings(c){
  c.innerHTML=`<div style="animation:fadeIn .4s"><h2 style="font-size:22px;font-weight:700;margin-bottom:4px">âš™ï¸ Admin Settings</h2>
  <p style="color:var(--t2);font-size:14px;margin-bottom:24px">Configure admin panel</p>
  
  <div class="card" style="margin-bottom:20px"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">ğŸ”’ Change Admin Password</h3>
  <div style="display:grid;gap:14px;max-width:400px">
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Current Password</label>
  <input class="inp" id="scur" type="password"></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">New Password</label>
  <input class="inp" id="snew" type="password"></div>
  <div><label style="font-size:12px;color:var(--t2);display:block;margin-bottom:6px">Confirm New Password</label>
  <input class="inp" id="scon" type="password"></div>
  <button class="btn btn-p" onclick="changePw()">Update Password</button></div></div>
  
  <div class="card" style="margin-bottom:20px"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px">ğŸ”— Firebase Configuration</h3>
  <p style="color:var(--t2);font-size:13px;margin-bottom:12px">${FB_READY?'ğŸŸ¢ Firebase is connected and syncing data':'ğŸŸ¡ Running in local-only mode. To enable multi-device sync and real user tracking, set up Firebase.'}</p>
  ${!FB_READY?`<div style="background:var(--bg3);border-radius:10px;padding:16px;font-size:13px;color:var(--t2);line-height:1.8">
  <strong style="color:var(--t1)">Setup Steps:</strong><br>
  1. Go to <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accL)">Firebase Console</a><br>
  2. Create a new project (free)<br>
  3. Enable Firestore Database<br>
  4. Go to Project Settings â†’ Your Apps â†’ Web<br>
  5. Copy the config object<br>
  6. Replace FIREBASE_CONFIG in both admin.html and placeprep.html</div>`:''}</div>
  
  <div class="card" style="border-color:rgba(239,68,68,.2)"><h3 style="font-size:15px;font-weight:600;margin-bottom:14px;color:var(--red)">âš ï¸ Danger Zone</h3>
  <button class="btn btn-d" onclick="if(confirm('Reset ALL data? This deletes all users, tests, and custom questions!'))resetAll()">ğŸ—‘ï¸ Reset All Data</button></div></div>`;
}

function changePw(){
  const cur=$('#scur').value,nw=$('#snew').value,con=$('#scon').value;
  const stored=localStorage.getItem('pp_admin_pw')||'admin123';
  if(cur!==stored){alert('Current password incorrect');return}
  if(nw.length<6){alert('New password must be 6+ characters');return}
  if(nw!==con){alert('Passwords do not match');return}
  localStorage.setItem('pp_admin_pw',nw);
  alert('âœ… Password updated!');
}

function resetAll(){
  const keys=Object.keys(localStorage).filter(k=>k.startsWith('pp_'));
  keys.forEach(k=>localStorage.removeItem(k));
  alert('All PlacePrep data has been reset.');render();
}

// Init
render();
</script>
</body>
</html>
